<app-navbar></app-navbar>

<div class="dashboard-container">
  <div class="content-wrapper">

    <!-- Alert Banner -->
    <app-alert-banner></app-alert-banner>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
      <div class="spinner"></div>
      <p>Loading your dashboard...</p>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" *ngIf="!loading">

      <!-- Welcome Header -->
      <header class="welcome-header">
        <div>
          <h1>{{ getGreeting() }}, {{ currentUser?.FirstName || 'there' }}!</h1>
          <p class="subtitle">Here's your well-being overview</p>
        </div>
        <button class="btn-primary" (click)="createNewShift()">
          ‚ûï Log New Shift
        </button>
      </header>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-value">{{ totalShifts }}</div>
            <div class="stat-label">Total Shifts</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üò∞</div>
          <div class="stat-content">
            <div class="stat-value">{{ averageStress }}/10</div>
            <div class="stat-label">Avg Stress</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üò¥</div>
          <div class="stat-content">
            <div class="stat-value">{{ averageSleep }}h</div>
            <div class="stat-label">Avg Sleep</div>
          </div>
        </div>

        <div class="stat-card" [ngClass]="getZoneClass(currentZone)">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <div class="stat-value">{{ currentZone | titlecase }}</div>
            <div class="stat-label">Current Zone</div>
          </div>
        </div>
      </div>

      <!-- Stress Graph -->
      <div class="graph-section">
        <div class="section-header">
          <h2>Stress Level Trend</h2>
          <span class="section-subtitle">Last 7 shifts</span>
        </div>

        <!-- Empty State -->
        <div class="empty-graph" *ngIf="stressData.length === 0">
          <div class="empty-icon">üìà</div>
          <h3>No data yet</h3>
          <p>Start logging shifts to see your stress trends</p>
          <button class="btn-secondary" (click)="createNewShift()">
            Log Your First Shift
          </button>
        </div>

        <!-- Stress Bar Chart -->
        <div class="stress-chart" *ngIf="stressData.length > 0">
          <div class="chart-container">
            <!-- Y-axis labels -->
            <div class="y-axis">
              <span class="y-label">10</span>
              <span class="y-label">8</span>
              <span class="y-label">6</span>
              <span class="y-label">4</span>
              <span class="y-label">2</span>
              <span class="y-label">0</span>
            </div>

            <!-- Chart bars -->
            <div class="chart-bars">
              <div class="bar-wrapper" *ngFor="let data of stressData">
                <div class="bar-container">
                  <div 
                    class="bar" 
                    [style.height.%]="getBarHeight(data.stressLevel)"
                    [style.background-color]="getStressColor(data.stressLevel)"
                    [title]="'Stress: ' + data.stressLevel + '/10'"
                  >
                    <span class="bar-value">{{ data.stressLevel }}</span>
                  </div>
                </div>
                <div class="bar-label">{{ data.displayDate }}</div>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div class="chart-legend">
            <div class="legend-item">
              <span class="legend-color" style="background-color: #48bb78;"></span>
              <span>Low (1-3)</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #ecc94b;"></span>
              <span>Moderate (4-6)</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #f56565;"></span>
              <span>High (7-10)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Latest Shift Insight -->
      <div class="insight-section" *ngIf="latestShift">
        <div class="section-header">
          <h2>Latest Shift Insight</h2>
          <button class="btn-link" (click)="viewAllShifts()">View All ‚Üí</button>
        </div>

        <div class="insight-card">
          <div class="insight-header">
            <div class="insight-date">
              <span class="date-icon">{{ latestShift.ShiftType === 'night' ? 'üåô' : '‚òÄÔ∏è' }}</span>
              <span>{{ formatShortDate(latestShift.ShiftDate) }}</span>
            </div>
            <span class="zone-badge" [ngClass]="getZoneClass(latestShift.Zone)">
              {{ latestShift.Zone || 'N/A' }}
            </span>
          </div>

          <div class="insight-stats">
            <div class="insight-stat">
              <span class="stat-label">SafeShift Index</span>
              <span class="stat-value" [ngClass]="getZoneClass(latestShift.Zone)">
                {{ latestShift.SafeShiftIndex || 'N/A' }}
              </span>
            </div>
            <div class="insight-stat">
              <span class="stat-label">Sleep</span>
              <span class="stat-value">{{ latestShift.HoursSleptBefore }}h</span>
            </div>
            <div class="insight-stat">
              <span class="stat-label">Stress</span>
              <span class="stat-value">{{ latestShift.StressLevel }}/10</span>
            </div>
          </div>

          <!-- AI Agent Insights (NEW!) -->
          <div class="agent-insights-container" *ngIf="latestShift.AgentInsights">
            
            <!-- Urgency Banner -->
            <div class="urgency-banner" [ngClass]="getUrgencyClass(latestShift.AgentInsights.urgency_level)">
              <span class="urgency-icon">
                {{ latestShift.AgentInsights.urgency_level === 'critical' ? '‚ö†Ô∏è' : 
                   latestShift.AgentInsights.urgency_level === 'urgent' ? 'üî¥' :
                   latestShift.AgentInsights.urgency_level === 'attention_needed' ? 'üü°' : 'üü¢' }}
              </span>
              <div class="urgency-content">
                <span class="urgency-label">{{ latestShift.AgentInsights.urgency_level | titlecase }}</span>
                <p class="urgency-summary">{{ latestShift.AgentInsights.summary }}</p>
              </div>
            </div>

            <!-- Primary Insights -->
            <div class="insights-grid" *ngIf="latestShift.AgentInsights.primary_insights?.length">
              <h4 class="insights-heading">Key Insights</h4>
              <div class="insight-cards">
                <div 
                  *ngFor="let insight of latestShift.AgentInsights.primary_insights" 
                  class="insight-item"
                  [class.high-priority]="insight.priority <= 2"
                >
                  <div class="insight-item-header">
                    <span class="category-icon">{{ getCategoryIcon(insight.category) }}</span>
                    <span class="category-label">{{ insight.category | titlecase }}</span>
                    <span class="priority-badge" *ngIf="insight.priority <= 2">Priority {{ insight.priority }}</span>
                  </div>
                  <p class="insight-message">{{ insight.message }}</p>
                  <p class="insight-supporting" *ngIf="insight.supporting_data">
                    <small>{{ insight.supporting_data }}</small>
                  </p>
                </div>
              </div>
            </div>

            <!-- Recommendations -->
            <div class="recommendations-section" *ngIf="latestShift.AgentInsights.recommendations?.length">
              <h4 class="insights-heading">Recommended Actions</h4>
              <div class="recommendations-list">
                <div 
                  *ngFor="let rec of latestShift.AgentInsights.recommendations" 
                  class="recommendation-item"
                >
                  <div class="recommendation-header">
                    <span class="timing-badge" [ngClass]="getTimingClass(rec.timing)">
                      {{ formatTiming(rec.timing) }}
                    </span>
                    <span class="source-agents" *ngIf="rec.source_agents?.length">
                      <small>From: {{ rec.source_agents.join(', ') }}</small>
                    </span>
                  </div>
                  <p class="recommendation-action">{{ rec.action }}</p>
                  <p class="recommendation-benefit" *ngIf="rec.expected_benefit">
                    <small>üí° {{ rec.expected_benefit }}</small>
                  </p>
                </div>
              </div>
            </div>

            <!-- Nurse Message -->
            <div class="message-box nurse-message" *ngIf="latestShift.AgentInsights.nurse_message">
              <div class="message-header">
                <span class="message-icon">üí¨</span>
                <span class="message-label">Personal Message</span>
              </div>
              <p>{{ latestShift.AgentInsights.nurse_message }}</p>
            </div>

          </div>

          <!-- Legacy AI Insights (fallback if AgentInsights not available) -->
          <div *ngIf="!latestShift.AgentInsights">
            <div class="insight-ai" *ngIf="latestShift.AiExplanation">
              <h4>Analysis</h4>
              <p>{{ latestShift.AiExplanation }}</p>
            </div>

            <div class="insight-ai" *ngIf="latestShift.AiTips">
              <h4>Recommendations</h4>
              <p style="white-space: pre-line;">{{ latestShift.AiTips }}</p>
            </div>
          </div>

        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="action-card" (click)="createNewShift()">
          <span class="action-icon">‚ûï</span>
          <span class="action-text">Log New Shift</span>
        </button>
        <button class="action-card" (click)="viewAllShifts()">
          <span class="action-icon">üìã</span>
          <span class="action-text">View All Shifts</span>
        </button>
      </div>

    </div>
  </div>
</div>
